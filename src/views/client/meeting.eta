<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nextbroadcast Media</title>
  <link rel="icon" type="image/x-icon" href="https://nextbroadcast.media/wp-content/uploads/2022/12/BROADCAST_BLACK.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <!-- Add Heroicons (for icons) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'nb-primary': '#3B82F6', // Brand blue
            'nb-dark': '#1D4ED8',    // Darker blue
            'nb-medium': '#F8FAFC',  // Light background
            'nb-light': '#F1F5F9',   // Even lighter
            'nb-text': '#0F172A',    // Dark text
            'nb-text-light': '#475569', // Medium text
            'nb-accent': '#F97316',  // Orange accent
            'nb-border': '#E2E8F0',  // Border color
          },
        }
      }
    }
  </script>
  <style>
    /* Custom styles */
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(to bottom, #F8FAFC, #F1F5F9);
      min-height: 100vh;
    }
    
    .hide {
      display: none !important;
    }
    
    .chat-collapsed {
      width: 60px !important;
      transition: width 0.3s ease;
    }
    
    .chat-expanded {
      transition: width 0.3s ease;
    }
    
    .video-with-chat {
      transition: width 0.3s ease;
    }
    
    .video-full {
      transition: width 0.3s ease;
    }
    
    /* Chat message animations */
    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message {
      animation: messageIn 0.3s ease forwards;
    }
    
    /* Video container enhancements */
    .video-shadow {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    /* Custom scrollbar */
    .nb-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .nb-scrollbar::-webkit-scrollbar-track {
      background-color: #F1F5F9;
      border-radius: 100px;
    }
    
    .nb-scrollbar::-webkit-scrollbar-thumb {
      background-color: #CBD5E1;
      border-radius: 100px;
    }
    /* Branded button styles */
    .nb-button {
      background: linear-gradient(280.71deg,#2535b4 15.9%,#c33764 88.58%);
      transition: all 0.2s ease;
    }
    
    .nb-button:hover {
      background: linear-gradient(280.71deg,#2535b4 15.9%,#c33764 88.58%);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
    }
    
    /* Logo animation */
    .logo-pulse {
      animation: pulse 4s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }
    /* Countdown timer */
    .countdown-item {
      background: white;
      border: 1px solid #E2E8F0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
  </style>
  <style>
  /* Mobile tab switching styles */
  .mobile-tabs {
    display: none;
  }
  
  @media (max-width: 768px) {
    .mobile-tabs {
      display: flex;
    }
    
    .tab-active {
      border-bottom: 3px solid #3B82F6;
      color: #3B82F6;
      font-weight: 600;
    }
    
    /* Full height video and chat on mobile */
    #videoSection, #chatSection {
      height: calc(100vh - 200px);
      max-height: none;
    }
    
    #video-container video {
      height: calc(100vh - 250px);
      object-fit: contain;
    }
    
    #chatMessages {
      height: calc(100vh - 300px);
    }
  }
</style>
  <!-- Add Socket.IO client library -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="text-nb-text">
  <div class="container-fluid mx-auto p-4">
    <% /* <header class="mb-8 flex justify-center items-center">
      <div class="flex items-center space-x-2">
        <img src="https://nextbroadcast.media/wp-content/uploads/2022/12/BROADCAST_BLACK.png" class="h-[100px]" />
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-nb-primary to-nb-accent">Nextbroadcast Media</h1>
      </div>
    </header> */ %>
    <!-- Meeting Information Section -->
    <div id="meetingInfoSection" class="hidden mb-8 bg-white rounded-xl p-6 max-w-3xl mx-auto border border-nb-border shadow-lg">
      <h2 id="meetingTitle" class="text-2xl font-bold mb-2 text-nb-dark capitalize">Loading meeting...</h2>
      <p id="meetingDescription" class="text-nb-text-light mb-6 capitalize">Please wait while we fetch the meeting details.</p>
      <!-- Agenda will be dynamically inserted here when available -->
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-nb-light p-4 rounded-lg border border-nb-border">
          <span class="text-nb-text-light text-sm">Start Date:</span>
          <div id="meetingDate" class="font-semibold text-nb-text">-</div>
        </div>
        <div class="bg-nb-light p-4 rounded-lg border border-nb-border">
          <span class="text-nb-text-light text-sm">Start Time:</span>
          <div id="meetingTime" class="font-semibold text-nb-text">-</div>
        </div>
      </div>
      
      <!-- Improved Countdown Timer -->
      <div id="timeRemainingSection" class="mt-8 text-center">
        <h3 class="text-xl font-bold text-nb-dark mb-5">Starting In</h3>
        <div class="flex justify-center gap-3 text-center">
          <div class="countdown-item rounded-xl p-2 md:p-5 w-24">
            <span id="remainingDays" class="text-lg md:text-3xl font-bold block text-nb-dark">00</span>
            <span class="text-sm text-nb-text-light mt-1">Days</span>
          </div>
          <div class="countdown-item rounded-xl p-2 md:p-5 w-24">
            <span id="remainingHours" class="text-lg md:text-3xl font-bold block text-nb-dark">00</span>
            <span class="text-sm text-nb-text-light mt-1">Hours</span>
          </div>
          <div class="countdown-item rounded-xl p-2 md:p-5 w-24">
            <span id="remainingMinutes" class="text-lg md:text-3xl font-bold block text-nb-dark">00</span>
            <span class="text-sm text-nb-text-light mt-1">Minutes</span>
          </div>
          <div class="countdown-item rounded-xl p-2 md:p-5 w-24">
            <span id="remainingSeconds" class="text-lg md:text-3xl font-bold block text-nb-dark">00</span>
            <span class="text-sm text-nb-text-light mt-1">Seconds</span>
          </div>
        </div>
        <p class="mt-5 text-nb-text-light">The meeting will begin automatically when the countdown ends or when it starts.</p>
      </div>
    </div>
    <!-- Main Content Area with Flexbox Layout -->
    <div class="flex flex-col md:flex-row gap-6" id="streamDiv">
    <div class="mobile-tabs md:hidden w-full mb-4 border-b border-nb-border">
      <button id="videoTab" class="w-1/2 p-3 text-center tab-active" onclick="showVideoTab()">
        <i class="ri-video-line mr-1"></i> Video
      </button>
      <button id="chatTab" class="w-1/2 p-3 text-center" onclick="showChatTab()">
        <i class="ri-chat-1-line mr-1"></i> Chat <span class="bg-green-500 text-white text-xs px-1.5 py-0.5 rounded-full" id="mobileActiveUsers">0</span>
      </button>
    </div>
      <!-- Left Side - Video Section -->
      <div id="videoSection" class="w-full md:w-2/3 video-with-chat transition-all duration-300">
        <div id="streamInfo" class="mb-4 flex items-center">
          <div class="w-3 h-3 bg-blue-500 rounded-full mr-2 animate-pulse"></div>
          <div id="status" class="text-xl font-semibold text-nb-dark">Waiting for stream to begin...</div>
        </div>
        <div id="video-container" class="hidden">
          <img src="https://nextbroadcast.media/wp-content/uploads/2022/12/BROADCAST_BLACK.png" class="h-[50px]" />

          <video id="video" loop="false" muted controls autoplay class="max-h-[600px] w-full rounded-xl border border-nb-border video-shadow"></video>
          
          <!-- Video controls overlay can be added here if needed -->
          <div class="mt-4 flex justify-between hidden items-center px-1">
            <div class="text-sm text-nb-text-light">
              <span class="text-nb-primary">Live Stream</span> â€¢ High Definition
            </div>
            <div class="flex items-center space-x-2">
              <button class="p-2 rounded-full bg-nb-light hover:bg-gray-200 transition-colors text-nb-text-light">
                <i class="ri-fullscreen-line text-lg"></i>
              </button>
              <button class="p-2 rounded-full bg-nb-light hover:bg-gray-200 transition-colors text-nb-text-light">
                <i class="ri-settings-3-line text-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Right Side - Chat Section with Collapse Button -->
      <div id="chatSection" class="w-full md:w-1/3 bg-white rounded-xl border border-nb-border shadow-lg flex flex-col max-h-[600px] chat-expanded relative transition-all duration-300">
        <!-- Collapse/Expand Button - Positioned on the left edge -->
        <button id="toggleChatBtn" class="absolute -left-4 top-1/2 transform -translate-y-1/2 bg-white text-nb-text-light w-8 h-20 rounded-l-lg flex items-center justify-center shadow-lg hover:bg-gray-100 transition-colors z-10 focus:outline-none border border-nb-border border-r-0">
          <i class="ri-arrow-right-s-line text-xl" id="chatCollapseIcon"></i>
        </button>
        
        <!-- Chat Header -->
        <div id="chatHeader" class="flex justify-between items-center p-4 border-b border-nb-border">
          <h2 class="text-xl font-bold text-nb-dark">Live Chat</h2>
          <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1 rounded-full text-sm flex items-center">
            <i class="ri-user-line mr-1"></i>
            <span id="activeUsers" class="mr-1">0</span> active
          </div>
        </div>
        
        <!-- Chat Content -->
        <div id="chatContent" class="flex-grow mb-2 flex flex-col p-4" style="max-height: 90%; min-height: 350px;">
          <!-- Chat Messages Container -->
          <div id="chatMessages" class="flex-grow overflow-y-auto mb-4 space-y-3 p-2 nb-scrollbar">
            <!-- Messages will be added here via JavaScript -->
            <% /* <div class="message bg-nb-light p-3 rounded-lg border border-nb-border">
              <div class="flex items-center gap-2">
                <span class="font-bold text-green-600">System:</span>
              </div>
              <p class="text-nb-text">Welcome to the live stream! Chat with others while watching.</p>
            </div> */ %>
          </div>
          
          <!-- Chat Input Form -->
          <div class="mt-auto">
            <form id="messageForm" class="flex gap-2">
              <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message..." 
                class="flex-grow bg-nb-light rounded-lg p-3 text-nb-text focus:outline-none focus:ring-2 focus:ring-nb-primary border border-nb-border placeholder-gray-400"
              >
              <button 
                type="submit" 
                class="nb-button px-4 py-2 rounded-lg flex items-center text-white"
                id="messageSendBtn"
              >
                <i class="ri-send-plane-fill mr-1"></i> Send
              </button>
            </form>
          </div>
        </div>
        
        <!-- Collapsed Chat View -->
        <div id="collapsedChatView" class="hidden h-full flex flex-col items-center justify-center p-2">
          <i class="ri-chat-3-line text-2xl mb-5 text-nb-primary"></i>
          <div class="writing-vertical transform rotate-90 text-sm text-nb-text-light whitespace-nowrap">Live Chat</div>
          <div class="mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mt-auto mb-4">
            <span id="collapsedActiveUsers">0</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Meeting Join Form -->
    <div id="nonStreamDiv" class="hidden mt-8">
      <div class="max-w-md mx-auto bg-white rounded-xl p-8 border border-nb-border shadow-lg">
        <div class="text-center mb-6">
          <% /* <div class="w-16 h-16 mx-auto rounded-full bg-gradient-to-r from-nb-primary to-nb-accent flex items-center justify-center mb-4 logo-pulse">
            <i class="ri-live-line text-3xl text-white"></i>
          </div> */ %>
          <div class="flex justify-center">
            <img src="https://nextbroadcast.media/wp-content/uploads/2022/12/BROADCAST_BLACK.png" class="h-[100px]" />
          </div>
          <h2 class="text-2xl font-bold mb-1 text-nb-dark">Join Meeting</h2>
          <p class="text-nb-text-light">Enter the meeting ID to connect</p>
        </div>
        <div class="space-y-4">
          <form action="/client/meeting" id="joinForm">
            <div>
              <label for="meetingIdControlInput" class="block text-sm font-medium mb-2 text-nb-text-light">Meeting ID</label>
              <input 
                type="text" 
                class="w-full bg-nb-light rounded-lg p-3 text-nb-text focus:outline-none focus:ring-2 focus:ring-nb-primary border border-nb-border" 
                id="meetingIdControlInput" 
                placeholder="Enter meeting ID"
                name="id"
              >
            </div>
            <div class="flex items-center justify-between mt-6">
              <button 
                class="nb-button w-full py-3 rounded-lg font-medium text-white flex items-center justify-center" 
                type="submit"
              >
                <i class="ri-login-circle-line mr-2"></i> Join Meeting
              </button>
            </div>
            <div class="text-center mt-3">
              <span id="meetingStatus" class="text-sm text-nb-text-light"></span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Existing JavaScript
    let meetingId = "<%= it.meeting ? it.meeting.uuid : '' %>";
    let streamUrl = `/live/${meetingId}/index.m3u8`;
    const video = document.getElementById('video');
    const videoContainer = document.getElementById('video-container');
    const status = document.getElementById('status');
    let timer = null, meetingTimer = null, countdownTimer = null;
    let isStreaming = false;
    let meetingData = null;
    let meetingStartTime = null;

    // Get additional elements for mobile
    const videoTab = document.getElementById('videoTab');
    const chatTab = document.getElementById('chatTab');
    const mobileActiveUsers = document.getElementById('mobileActiveUsers');
    


    // Chat functionality
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const activeUsersElement = document.getElementById('activeUsers');
    const collapsedActiveUsers = document.getElementById('collapsedActiveUsers');
    const toggleChatBtn = document.getElementById('toggleChatBtn');
    const chatSection = document.getElementById('chatSection');
    const chatContent = document.getElementById('chatContent');
    const collapsedChatView = document.getElementById('collapsedChatView');
    const videoSection = document.getElementById('videoSection');
    const chatCollapseIcon = document.getElementById('chatCollapseIcon');
    
    let isChatCollapsed = false;
    let activeUsers = 0; // Initial count
    let socket; // WebSocket connection
    let intervalTimeout = 5000;


    // Mobile tab switching functions
    function showVideoTab() {
      videoTab.classList.add('tab-active');
      chatTab.classList.remove('tab-active');
      
      // Show video, hide chat on mobile
      if (window.innerWidth < 768) {
        videoSection.classList.remove('hidden');
        chatSection.classList.add('hidden');
      }
    }

    function showChatTab() {
      chatTab.classList.add('tab-active');
      videoTab.classList.remove('tab-active');
      
      // Show chat, hide video on mobile
      if (window.innerWidth < 768) {
        chatSection.classList.remove('hidden');
        videoSection.classList.add('hidden');
      }
    }
    


    // Handle chat collapsing
    toggleChatBtn.addEventListener('click', function() {
      isChatCollapsed = !isChatCollapsed;
      
      if (isChatCollapsed) {
        // Collapse chat
        chatSection.classList.remove('chat-expanded');
        chatSection.classList.add('chat-collapsed');
        chatContent.classList.add('hidden');
        collapsedChatView.classList.remove('hidden');
        videoSection.classList.remove('video-with-chat');
        videoSection.classList.add('video-full', 'md:w-[calc(100%-80px)]');
        chatCollapseIcon.classList.remove('ri-arrow-right-s-line');
        chatCollapseIcon.classList.add('ri-arrow-left-s-line');
        document.getElementById("chatHeader").classList.add("hidden");
      } else {
        // Expand chat
        chatSection.classList.remove('chat-collapsed');
        chatSection.classList.add('chat-expanded');
        chatContent.classList.remove('hidden');
        collapsedChatView.classList.add('hidden');
        videoSection.classList.add('video-with-chat');
        videoSection.classList.remove('video-full', 'md:w-[calc(100%-80px)]');
        videoSection.classList.add('md:w-2/3');
        chatCollapseIcon.classList.add('ri-arrow-right-s-line');
        chatCollapseIcon.classList.remove('ri-arrow-left-s-line');
        document.getElementById("chatHeader").classList.remove("hidden")
      }
    });

    function showStreamDiv(){
        document.getElementById("streamDiv").classList.remove("hidden");
        document.getElementById("nonStreamDiv").classList.add("hidden");    
    }

    function showNonStreamDiv(){
        document.getElementById("streamDiv").classList.add("hidden");
        document.getElementById("nonStreamDiv").classList.remove("hidden");    
    }    

    if(meetingId){
      document.getElementById("meetingIdControlInput").value = meetingId;
    }
    
    showNonStreamDiv();

    // The rest of your JavaScript remains the same
    function getPublicPath(){
      console.log("get public path");
      fetch(`/client/event/public?id=${meetingId}`).then(res => res.json()).then(res => {
        console.log(res);
        if(res.filepath){
          document.getElementById("video").src = res.filepath;
        }
      });
    }

    function checkMeeting(){
      fetch(`/client/event/${meetingId}`)
        .then((res) => res.json())
        .catch((err) => { return {status:"error"} })
        .then((res) => {
          console.log(res);
          if(res["status"] === "error"){
            alert("Meeting not found");

            if(meetingTimer)
              clearInterval(meetingTimer);
            return;
          }
          meetingData = res;
          updateMeetingInfo(res);
          document.getElementById("nonStreamDiv").classList.add("hidden");
          const status = parseInt(res['status']);
          if(status == 0){
            console.log("meeting has not yet started");
            document.getElementById("meetingStatus").innerHTML = `Meeting has not yet started`;
            showMeetingCountdown(res);
            
            // Show meeting info section but hide stream
            document.getElementById("meetingInfoSection").classList.remove("hidden");
            document.getElementById("streamDiv").classList.add("hidden");
            //showNonStreamDiv();
          } else if(status == 1) {
            if(meetingTimer)
              clearInterval(meetingTimer);
            if(countdownTimer)
              clearInterval(countdownTimer);
            document.getElementById("timeRemainingSection").classList.add("hidden");
            timer = setInterval(checkStream, intervalTimeout);
            
            // Keep meeting info visible but also show stream
            document.getElementById("meetingInfoSection").classList.add("hidden");
            showStreamDiv();
            getPreviousMessage(false);
            initializeChat(); // Connect to chat when meeting is active
          } else if(status == 2){
            if(meetingTimer)
              clearInterval(meetingTimer);
            if(countdownTimer)
              clearInterval(countdownTimer);
            document.getElementById("timeRemainingSection").classList.add("hidden");
            
            // Keep meeting info visible but also show stream
            document.getElementById("meetingInfoSection").classList.add("hidden");
            showStreamDiv();
            videoContainer.classList.remove('hidden');
            document.getElementById("streamInfo").classList.add("hidden");
            getPublicPath();
            getPreviousMessage(true);            
            <% /* initializeChat(true); // Connect to chat when meeting is recorded */ %>
          }
      })
      .catch(err => {
        console.error("Error fetching meeting data:", err);
      });
    }

    function updateMeetingInfo(data) {
      // Update meeting info elements
      document.getElementById("meetingTitle").textContent = data.title || "Untitled Meeting";
      document.getElementById("meetingDescription").textContent = data.description || "No description available";
      
      // Add agenda if available
      if (data.agenda) {
        const agendaElement = document.getElementById("meetingAgenda") || document.createElement("p");
        agendaElement.id = "meetingAgenda";
        agendaElement.className = "text-gray-600 mt-2";
        agendaElement.innerHTML = `<strong>Agenda:</strong> ${data.agenda}`;
        
        // If element doesn't exist yet, add it after the description
        if (!document.getElementById("meetingAgenda")) {
          const descriptionElement = document.getElementById("meetingDescription");
          descriptionElement.parentNode.insertBefore(agendaElement, descriptionElement.nextSibling);
        }
      }
      
      // Format and display dates
      if (data.start_date && data.start_time && data.timezone) {
        // Use Luxon to handle timezones
        const { DateTime } = luxon;
        
        // Combine date and time with timezone
        const meetingDateTime = DateTime.fromFormat(
          `${data.start_date} ${data.start_time}:00`, // Add seconds since API doesn't include them
          "yyyy-MM-dd HH:mm:ss", 
          { zone: data.timezone }
        );
        
        // Store for countdown
        meetingStartTime = meetingDateTime;
        
        // Convert to local timezone for display
        const localDateTime = meetingDateTime.toLocal();
        
        // Format for display
        document.getElementById("meetingDate").textContent = localDateTime.toFormat("EEE, MMM d, yyyy");
        document.getElementById("meetingTime").textContent = localDateTime.toFormat("h:mm a") + 
          ` (${localDateTime.offsetNameShort})`;
      } else {
        document.getElementById("meetingDate").textContent = "Not specified";
        document.getElementById("meetingTime").textContent = "Not specified";
      }
    }

    // Existing functions for meeting countdown, etc.
    function showMeetingCountdown(data) {
      //debugger
      // Only proceed if we have valid date/time data
      if (!data.start_date || !data.start_time || !data.timezone) {
        document.getElementById("timeRemainingSection").classList.add("hidden");
        return;
      }
      
      // Always show the countdown section when status is 0 (not started)
      document.getElementById("timeRemainingSection").classList.remove("hidden");
      
      // Create the DateTime object if not already created
      if (!meetingStartTime) {
        const { DateTime } = luxon;
        meetingStartTime = DateTime.fromFormat(
          `${data.start_date} ${data.start_time}:00`, // Add seconds since API doesn't include them
          "yyyy-MM-dd HH:mm:ss", 
          { zone: data.timezone }
        );
      }
      
      // Update countdown immediately
      updateCountdown();
      
      // Set up interval to update countdown
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(updateCountdown, 1000);
    }


    function updateCountdown() {
      console.log("update coutn dount");      
      //debugger
      if (!meetingStartTime) return;

      const { DateTime } = luxon;
      const now = DateTime.local();
      
      // Calculate the difference
      const diff = meetingStartTime.diff(now, ['days', 'hours', 'minutes', 'seconds']);
      
      console.log("diff.milliseconds ",diff.milliseconds);
      // If meeting time is in the past, stop countdown and check meeting again
      if (diff.milliseconds <= 0 && diff.minutes <=0 && diff.hours <=0 && diff.days <= 0) {
        clearInterval(countdownTimer);
        //document.getElementById("timeRemainingSection").classList.add("hidden");
        //checkMeeting(); // Check if meeting status has changed
        return;
      }

      if( diff.days > 0 || diff.hours > 0 || diff.minutes > 30 ){
        if(intervalTimeout === 5000){
          intervalTimeout = 1000 * 60 * 60;
          checkMeetingWithInterval();
        }
      }else {
        if(intervalTimeout === 1000 * 60 * 60){
          intervalTimeout = 5000;
          checkMeetingWithInterval();
        }
      }

      //checkMeetingWithInterval();
      
      // Update the countdown display with padded values
      document.getElementById("remainingDays").textContent = String(Math.floor(diff.days)).padStart(2, '0');
      document.getElementById("remainingHours").textContent = String(Math.floor(diff.hours)).padStart(2, '0');
      document.getElementById("remainingMinutes").textContent = String(Math.floor(diff.minutes)).padStart(2, '0');
      document.getElementById("remainingSeconds").textContent = String(Math.floor(diff.seconds)).padStart(2, '0');
    }

    function checkStream() {
      streamUrl = `/live/${meetingId}/index.m3u8`;
      fetch(streamUrl, { method: 'HEAD' })
        .then(res => {
          if (res.ok && !isStreaming) {
            status.innerText = "";
            videoContainer.classList.remove('hidden');
            startPlayer();
            isStreaming = true;
            clearInterval(timer);
          } else if (!res.ok && isStreaming) {
            status.innerText = "âš« Stream ended.";
            videoContainer.classList.add('hidden');
            isStreaming = false;
            clearInterval(timer);
          } else if (!res.ok) {
            status.innerText = "ðŸ”µ Waiting for stream...";
          }
        })
        .catch(err => {
          status.innerText = "âš« Offline or unreachable.";
          videoContainer.classList.add('hidden');
          isStreaming = false;
        });
    }

    function startPlayer() {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(streamUrl);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streamUrl;
      }
      video.play();
    }

    // Initialize WebSocket connection for chat
    function initializeChat() {

      // Connect to Socket.IO
      socket = io('/chat');
      
      // Join the meeting room
      socket.emit('join_room', meetingId);
      
      // Listen for user count updates
      socket.on('users_update', (data) => {
        activeUsers = data.count;
        activeUsersElement.textContent = activeUsers;
        collapsedActiveUsers.textContent = activeUsers;
        mobileActiveUsers.textContent = activeUsers; // Update mobile tab counter
      });
      
      // Listen for chat messages
      socket.on('chat_message', (data) => {
        addChatMessage(data.username, data.message, data.timestamp);
        

        <% /* // If chat is collapsed and we receive a message, flash the chat icon
        if (isChatCollapsed) {
          flashChatIcon();
        } */ %>

        // Flash chat tab if we're on video tab
        if (videoTab.classList.contains('tab-active') && window.innerWidth < 768) {
          chatTab.classList.add('animate-pulse', 'text-nb-primary');
          setTimeout(() => {
            chatTab.classList.remove('animate-pulse', 'text-nb-primary');
          }, 2000);
        }
      });
      
      // Handle connection errors
      socket.on('connect_error', () => {
        addSystemMessage("Error connecting to chat");
      });
      
      // Handle disconnection
      socket.on('disconnect', () => {
        addSystemMessage("Disconnected from chat");
      });
      
      // Handle reconnection
      socket.on('reconnect', () => {
        addSystemMessage("Reconnected to chat");
        socket.emit('join_room', meetingId);
      });
    }

    function flashChatIcon() {
      // Flash the chat icon when collapsed and new messages arrive
      const icon = collapsedChatView.querySelector('i');
      icon.classList.add('text-blue-500', 'animate-pulse');
      
      setTimeout(() => {
        icon.classList.remove('text-blue-500', 'animate-pulse');
      }, 2000);
    }


    // Initial setup for mobile
    function setupMobileLayout() {
      if (window.innerWidth < 768) {
        // Start with video tab active
        showVideoTab();
        
        // Remove toggle chat button on mobile
        toggleChatBtn.classList.add('hidden');
      } else {
        // Make sure both are visible on desktop
        videoSection.classList.remove('hidden');
        chatSection.classList.remove('hidden');
        toggleChatBtn.classList.remove('hidden');
      }
    }


    function getPreviousMessage(ended = false){

      if(ended){
        //document.getElementById("messageForm").classList.add("hidden");    
        document.getElementById("messageInput").disabled = true;
        document.getElementById("messageSendBtn").disabled = true;
      }else {
        //document.getElementById("messageForm").classList.remove("hidden");
        document.getElementById("messageInput").disabled = false;
        document.getElementById("messageSendBtn").disabled = false;

      }

      fetch("/client/api/messages/"+meetingId).then((res) => res.json()).then(res => {
        console.log("messages ",res, );
        if(res && res['messages'] && Array.isArray(res['messages']) && res['messages'].length){
          for(let i=0;i<res['messages'].length;i++){
             addChatMessage(res['messages'][i]['user_uid'], res['messages'][i]['message'], new Date(res['messages'][i]['createdAt']))
          }
        }
      });
    }

    // Add a chat message to the UI
    function addChatMessage(username, message, timestamp) {
      console.log("addChatMessage ", {username, message, timestamp});
      const messageElement = document.createElement('div');
      messageElement.className = 'message bg-zinc-200 p-3 rounded-lg mb-2';
      
      const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageElement.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="font-bold text-blue-400">${username}</span>
          <span class="text-xs text-gray-400">${time}</span>
        </div>
        <p class="break-words">${message}</p>
      `;
      
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add a system message to the chat
    function addSystemMessage(message) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message bg-zinc-200 p-3 rounded-lg mb-2';
      
      messageElement.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="font-bold text-green-400">System:</span>
        </div>
        <p>${message}</p>
      `;
      
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Handle message form submission
    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const message = messageInput.value.trim();
      if (message && socket && socket.connected) {
        // Send via Socket.IO
        socket.emit('chat_message', { message: message });
        
        // Clear input after sending
        messageInput.value = '';
      }
    });
    
    function checkMeetingWithInterval(){
      console.log(" checkMeetingWithInterval " ,intervalTimeout);
      //debugger
      if(meetingTimer)
        clearInterval(meetingTimer);

      if(meetingId) {
          meetingTimer = setInterval(checkMeeting, intervalTimeout);
      }    
    }

    // Call checkMeeting immediately to show meeting info
    if(meetingId) {
      checkMeeting();
      checkMeetingWithInterval();
    }

    document.getElementById("joinForm").addEventListener("submit", (ev) => {
      ev.preventDefault();
      meetingId =  document.getElementById("meetingIdControlInput").value;
      meetingId = meetingId.trim();
      checkMeeting();
      checkMeetingWithInterval();
      document.getElementById("video").muted = false
    });

    // Run on load and resize
    window.addEventListener('resize', setupMobileLayout);
    setupMobileLayout();
  </script>
</body>
</html>